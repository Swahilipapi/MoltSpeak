<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documentation - MoltSpeak Protocol</title>
  <meta name="description" content="Complete MoltSpeak protocol specification and documentation.">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="nav-content">
      <a href="../index.html" class="nav-logo">
        <svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="10" cy="16" r="6" stroke="currentColor" stroke-width="2"/>
          <circle cx="22" cy="16" r="6" stroke="currentColor" stroke-width="2"/>
          <path d="M16 16L18 14M16 16L18 18M16 16L14 14M16 16L14 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        MoltSpeak
      </a>
      <button class="nav-toggle" aria-label="Toggle navigation">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
      </button>
      <ul class="nav-links">
        <li><a href="../index.html">Home</a></li>
        <li><a href="docs.html" class="active">Docs</a></li>
        <li><a href="playground.html">Playground</a></li>
        <li><a href="examples.html">Examples</a></li>
        <li><a href="security.html">Security</a></li>
        <li><a href="compare.html">Compare</a></li>
        <li><a href="use-cases.html">Use Cases</a></li>
        <li><a href="contribute.html">Contribute</a></li>
        <li><a href="https://github.com/Swahilipapi/MoltSpeak" class="nav-github">GitHub</a></li>
      </ul>
    </div>
  </nav>

  <div class="docs-layout container">
    <!-- Sidebar -->
    <aside class="docs-sidebar">
      <nav class="docs-nav">
        <div class="docs-nav-section">
          <div class="docs-nav-title">Getting Started</div>
          <a href="#overview">Overview</a>
          <a href="#principles">Design Principles</a>
          <a href="#quick-reference">Quick Reference</a>
        </div>
        
        <div class="docs-nav-section">
          <div class="docs-nav-title">Message Format</div>
          <a href="#message-structure">Base Structure</a>
          <a href="#field-reference">Field Reference</a>
          <a href="#envelope">Envelope</a>
        </div>
        
        <div class="docs-nav-section">
          <div class="docs-nav-title">Handshake</div>
          <a href="#identity">Identity Model</a>
          <a href="#handshake-flow">Handshake Flow</a>
          <a href="#verification">Verification</a>
        </div>
        
        <div class="docs-nav-section">
          <div class="docs-nav-title">Operations</div>
          <a href="#operations">All Operations</a>
          <a href="#op-query">query</a>
          <a href="#op-respond">respond</a>
          <a href="#op-task">task</a>
          <a href="#op-tool">tool</a>
          <a href="#op-stream">stream</a>
          <a href="#op-consent">consent</a>
          <a href="#op-error">error</a>
        </div>
        
        <div class="docs-nav-section">
          <div class="docs-nav-title">Security</div>
          <a href="#capabilities">Capabilities</a>
          <a href="#classification">Classification</a>
          <a href="#pii">PII Handling</a>
        </div>
        
        <div class="docs-nav-section">
          <div class="docs-nav-title">Advanced</div>
          <a href="#extensions">Extensions</a>
          <a href="#errors">Error Codes</a>
          <a href="#transport">Transport</a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="docs-content">
      <h1>MoltSpeak Protocol Specification</h1>
      <p class="hero-subtitle" style="font-size: 1.125rem;">Version 0.1.1 (Draft)</p>

      <section id="overview">
        <h2>Overview</h2>
        <p>MoltSpeak is a structured communication protocol designed for AI agents to communicate efficiently, securely, and unambiguously. It prioritizes:</p>
        
        <ul>
          <li><strong>Compactness</strong>: 10x reduction vs natural language for common operations</li>
          <li><strong>Security</strong>: E2E encryption, verified identities, explicit data classification</li>
          <li><strong>Privacy</strong>: PII detection, consent tracking, data minimization</li>
          <li><strong>Interoperability</strong>: Model-agnostic, platform-agnostic</li>
          <li><strong>Auditability</strong>: Human-readable when inspected</li>
        </ul>
        
        <div class="notice notice-info">
          <div class="notice-title">Why JSON?</div>
          <p>Universal parser support, human-readable for audit/debug, sufficient for agent-scale throughput, easy to sign and encrypt (vs binary).</p>
        </div>

        <div class="notice notice-success">
          <div class="notice-title">ğŸ§ª Tested & CI-Verified</div>
          <p>MoltSpeak has <strong>400+ tests</strong> across both TypeScript and Python SDKs, with continuous integration via GitHub Actions. <a href="https://github.com/Swahilipapi/MoltSpeak/actions">View CI status â†’</a></p>
          <p style="margin-top: 0.5rem;">Test suites: <a href="https://github.com/Swahilipapi/MoltSpeak/tree/main/sdks/typescript/src/__tests__">TypeScript tests</a> | <a href="https://github.com/Swahilipapi/MoltSpeak/tree/main/sdks/python/tests">Python tests</a></p>
        </div>
      </section>

      <section id="principles">
        <h2>Design Principles</h2>
        
        <h3>1. Fail-Safe Default</h3>
        <p>If a message is unclear, malformed, or missing required fields â†’ <strong>DO NOT PROCESS</strong>. Return an error. Never guess.</p>
        
        <h3>2. Explicit Over Implicit</h3>
        <p>All context must be in the message. No assumptions about shared state.</p>
        
        <h3>3. Privacy by Default</h3>
        <p>PII is never transmitted unless explicitly tagged with consent proof.</p>
        
        <h3>4. Human Auditable</h3>
        <p>Messages use JSON (not binary) so humans can inspect, log, and debug.</p>
        
        <h3>5. Minimal Trust</h3>
        <p>Verify everything. Capabilities must be proven, not claimed.</p>
        
        <h3>6. Extensible Core</h3>
        <p>The protocol defines a stable core with namespaced extensions.</p>
      </section>

      <section id="quick-reference">
        <h2>Quick Reference</h2>
        <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  MoltSpeak Quick Ref                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Message: {v, id, ts, op, from, to, p, cls, sig}        â”‚
â”‚                                                        â”‚
â”‚ Operations:                                            â”‚
â”‚   hello     - Initiate handshake                       â”‚
â”‚   verify    - Challenge/response auth                  â”‚
â”‚   query     - Request information                      â”‚
â”‚   respond   - Reply to query                           â”‚
â”‚   task      - Delegate work                            â”‚
â”‚   stream    - Large/realtime data                      â”‚
â”‚   tool      - Invoke tool                              â”‚
â”‚   consent   - PII consent flow                         â”‚
â”‚   error     - Error response                           â”‚
â”‚                                                        â”‚
â”‚ Classifications: pub, int, conf, pii, sec              â”‚
â”‚                                                        â”‚
â”‚ Golden Rule: Unclear = Don't transmit                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
      </section>

      <section id="message-structure">
        <h2>Base Message Structure</h2>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "v": "0.1",
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "ts": 1703280000000,
  "op": "query",
  "from": {
    "agent": "claude-agent-7x9k",
    "org": "anthropic",
    "key": "ed25519:abc123..."
  },
  "to": {
    "agent": "gpt-assistant-m2n4",
    "org": "openai"
  },
  "p": {},
  "cls": "internal",
  "sig": "ed25519:..."
}</code></pre>
        </div>
      </section>

      <section id="field-reference">
        <h2>Field Reference</h2>
        
        <table>
          <thead>
            <tr>
              <th>Full Name</th>
              <th>Short Key</th>
              <th>Type</th>
              <th>Required</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>version</td><td><code>v</code></td><td>string</td><td>âœ“</td></tr>
            <tr><td>message_id</td><td><code>id</code></td><td>string (UUID)</td><td>âœ“</td></tr>
            <tr><td>timestamp</td><td><code>ts</code></td><td>integer (unix ms)</td><td>âœ“</td></tr>
            <tr><td>operation</td><td><code>op</code></td><td>string</td><td>âœ“</td></tr>
            <tr><td>sender</td><td><code>from</code></td><td>object</td><td>Most ops</td></tr>
            <tr><td>recipient</td><td><code>to</code></td><td>object</td><td>Most ops</td></tr>
            <tr><td>payload</td><td><code>p</code></td><td>object</td><td>âœ“</td></tr>
            <tr><td>classification</td><td><code>cls</code></td><td>string</td><td>Recommended</td></tr>
            <tr><td>signature</td><td><code>sig</code></td><td>string</td><td>Auth required</td></tr>
            <tr><td>encryption</td><td><code>enc</code></td><td>object</td><td>-</td></tr>
            <tr><td>reply_to</td><td><code>re</code></td><td>string (message id)</td><td>For responses</td></tr>
            <tr><td>expires</td><td><code>exp</code></td><td>integer (unix ms)</td><td>-</td></tr>
            <tr><td>capabilities_required</td><td><code>cap</code></td><td>array</td><td>-</td></tr>
          </tbody>
        </table>
      </section>

      <section id="envelope">
        <h2>Envelope Structure</h2>
        <p>Messages are wrapped in an envelope for transport:</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "moltspeak": "0.1",
  "envelope": {
    "encrypted": false,
    "compressed": false,
    "encoding": "utf-8"
  },
  "message": { ... }
}</code></pre>
        </div>
        
        <h3>Encrypted Envelope</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "moltspeak": "0.1",
  "envelope": {
    "encrypted": true,
    "algorithm": "x25519-xsalsa20-poly1305",
    "sender_public": "x25519:abc...",
    "nonce": "base64:..."
  },
  "ciphertext": "base64:..."
}</code></pre>
        </div>
      </section>

      <section id="identity">
        <h2>Identity Model</h2>
        <p>Each agent has:</p>
        <ul>
          <li><strong>Agent ID</strong>: Unique identifier (format: <code>{model}-{role}-{instance}</code>)</li>
          <li><strong>Organization</strong>: The controlling entity</li>
          <li><strong>Public Key</strong>: Ed25519 for signing, X25519 for encryption</li>
          <li><strong>Capability Set</strong>: What operations this agent can perform</li>
          <li><strong>Trust Level</strong>: Determined by verification chain</li>
        </ul>
      </section>

      <section id="handshake-flow">
        <h2>Handshake Flow</h2>
        <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent A   â”‚                           â”‚   Agent B   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                         â”‚
       â”‚  1. HELLO (my identity, my caps)        â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                         â”‚
       â”‚  2. HELLO_ACK (your identity, my caps)  â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                         â”‚
       â”‚  3. VERIFY (challenge)                  â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                         â”‚
       â”‚  4. VERIFY_RESPONSE (signed challenge)  â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                         â”‚
       â”‚  5. SESSION_ESTABLISHED                 â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                         â”‚</div>
        
        <h3>HELLO Message</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "v": "0.1",
  "op": "hello",
  "from": {
    "agent": "claude-assistant-a1b2",
    "org": "anthropic",
    "key": "ed25519:mKj8Gf2...",
    "enc_key": "x25519:nL9hHg3..."
  },
  "p": {
    "protocol_versions": ["0.1"],
    "capabilities": ["query", "task", "stream"],
    "extensions": ["tool-use", "memory"],
    "max_message_size": 1048576,
    "supported_cls": ["public", "internal", "confidential"]
  },
  "ts": 1703280000000,
  "sig": "ed25519:..."
}</code></pre>
        </div>
      </section>

      <section id="verification">
        <h2>Verification</h2>
        <p>After hello exchange, agents verify each other's identity:</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "v": "0.1",
  "op": "verify",
  "p": {
    "challenge": "random-256-bit-value",
    "timestamp": 1703280001000
  },
  "sig": "ed25519:..."
}</code></pre>
        </div>
        
        <p>After verification, a session is established with:</p>
        <ul>
          <li><strong>Session ID</strong>: Shared reference for this conversation</li>
          <li><strong>Session Key</strong>: Derived via X25519 key exchange</li>
          <li><strong>Expiry</strong>: Session timeout (default: 1 hour)</li>
        </ul>
      </section>

      <section id="operations">
        <h2>All Operations</h2>
        <table>
          <thead>
            <tr>
              <th>Operation</th>
              <th>Purpose</th>
              <th>Response</th>
            </tr>
          </thead>
          <tbody>
            <tr><td><code>hello</code></td><td>Initiate handshake</td><td>hello_ack</td></tr>
            <tr><td><code>verify</code></td><td>Challenge-response auth</td><td>verify_response</td></tr>
            <tr><td><code>query</code></td><td>Request information</td><td>respond</td></tr>
            <tr><td><code>respond</code></td><td>Reply to query</td><td>-</td></tr>
            <tr><td><code>task</code></td><td>Delegate work</td><td>task_ack / respond</td></tr>
            <tr><td><code>stream</code></td><td>Large/realtime data</td><td>stream chunks</td></tr>
            <tr><td><code>tool</code></td><td>Invoke tool</td><td>respond</td></tr>
            <tr><td><code>consent</code></td><td>PII consent flow</td><td>consent_response</td></tr>
            <tr><td><code>error</code></td><td>Error response</td><td>-</td></tr>
          </tbody>
        </table>
      </section>

      <section id="op-query">
        <h2>query</h2>
        <p>Request information from another agent.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "query",
  "p": {
    "domain": "weather",
    "intent": "forecast",
    "params": {
      "location": "Tokyo",
      "timeframe": "+1d"
    },
    "response_format": {
      "type": "structured",
      "schema": "weather-forecast-v1"
    }
  }
}</code></pre>
        </div>
      </section>

      <section id="op-respond">
        <h2>respond</h2>
        <p>Reply to a query. Must include <code>re</code> field referencing the original message.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "respond",
  "re": "550e8400-e29b-41d4-a716-446655440000",
  "p": {
    "status": "success",
    "data": {
      "location": "Tokyo",
      "date": "2024-12-23",
      "high_c": 12,
      "low_c": 5,
      "conditions": "partly-cloudy"
    },
    "schema": "weather-forecast-v1"
  }
}</code></pre>
        </div>
      </section>

      <section id="op-task">
        <h2>task</h2>
        <p>Delegate a task to another agent with constraints and callbacks.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "task",
  "p": {
    "action": "create",
    "task_id": "task-789",
    "type": "research",
    "description": "Find recent papers on transformer efficiency",
    "constraints": {
      "max_results": 10,
      "recency": "6mo",
      "sources": ["arxiv", "semanticscholar"]
    },
    "deadline": 1703283600000,
    "priority": "normal",
    "callback": {
      "on_complete": true,
      "on_progress": false
    }
  }
}</code></pre>
        </div>
      </section>

      <section id="op-tool">
        <h2>tool</h2>
        <p>Invoke a tool through another agent.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "tool",
  "p": {
    "action": "invoke",
    "tool": "web-search",
    "input": {
      "query": "MoltSpeak protocol",
      "max_results": 5
    }
  },
  "cap": ["tool.invoke"]
}</code></pre>
        </div>
      </section>

      <section id="op-stream">
        <h2>stream</h2>
        <p>For large or real-time data.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "stream",
  "p": {
    "action": "start",
    "stream_id": "stream-456",
    "type": "text",
    "chunk_size": 1024
  }
}</code></pre>
        </div>
      </section>

      <section id="op-consent">
        <h2>consent</h2>
        <p>Handle human data consent flows for PII.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "consent",
  "p": {
    "action": "request",
    "data_types": ["calendar", "email"],
    "purpose": "Schedule coordination",
    "duration": "session",
    "human": "user:jane@example.com"
  }
}</code></pre>
        </div>
      </section>

      <section id="op-error">
        <h2>error</h2>
        <p>Structured error with code, category, and recovery hints.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "error",
  "re": "original-message-id",
  "p": {
    "code": "E_INVALID_PARAM",
    "category": "validation",
    "message": "Parameter 'location' is required for weather queries",
    "field": "p.params.location",
    "recoverable": true,
    "suggestion": {
      "action": "retry",
      "fix": "Add location parameter"
    }
  }
}</code></pre>
        </div>
      </section>

      <section id="capabilities">
        <h2>Capability Categories</h2>
        <table>
          <thead>
            <tr><th>Category</th><th>Capabilities</th></tr>
          </thead>
          <tbody>
            <tr><td>core</td><td>query, respond, error</td></tr>
            <tr><td>task</td><td>task.create, task.status, task.cancel</td></tr>
            <tr><td>stream</td><td>stream.start, stream.chunk, stream.end</td></tr>
            <tr><td>tool</td><td>tool.invoke, tool.list</td></tr>
            <tr><td>memory</td><td>memory.store, memory.retrieve</td></tr>
            <tr><td>human</td><td>human.consent, human.notify</td></tr>
            <tr><td>code</td><td>code.execute, code.sandbox</td></tr>
          </tbody>
        </table>
        
        <h3>Capability Attestation</h3>
        <p>Capabilities can be self-declared (low trust), org-attested (signed by organization), or verified through challenge-response.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "capability": "code.execute",
  "attestation": {
    "type": "org-signed",
    "org": "anthropic",
    "signature": "ed25519:...",
    "expires": 1735689600000
  }
}</code></pre>
        </div>
      </section>

      <section id="classification">
        <h2>Data Classification</h2>
        <p>Every message MUST have a classification tag (<code>cls</code> field).</p>
        
        <table>
          <thead>
            <tr><th>Level</th><th>Tag</th><th>Description</th><th>Handling</th></tr>
          </thead>
          <tbody>
            <tr><td>Public</td><td><code>pub</code></td><td>Safe for anyone</td><td>No restrictions</td></tr>
            <tr><td>Internal</td><td><code>int</code></td><td>Agent-to-agent only</td><td>Log ok, no human view by default</td></tr>
            <tr><td>Confidential</td><td><code>conf</code></td><td>Sensitive business data</td><td>Encrypted, limited retention</td></tr>
            <tr><td>PII</td><td><code>pii</code></td><td>Personal data</td><td>Consent required, masked by default</td></tr>
            <tr><td>Secret</td><td><code>sec</code></td><td>Credentials, keys</td><td>Never log, memory-only</td></tr>
          </tbody>
        </table>
      </section>

      <section id="pii">
        <h2>PII Handling</h2>
        <p>When transmitting PII, messages must include consent proof:</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "cls": "pii",
  "pii_meta": {
    "types": ["name", "email", "location"],
    "consent": {
      "granted_by": "user:jane@example.com",
      "purpose": "calendar-sync",
      "expires": 1703366400000,
      "proof": "consent-token:abc123"
    },
    "mask_fields": ["email"]
  }
}</code></pre>
        </div>
        
        <div class="notice notice-warning">
          <div class="notice-title">Automatic PII Detection</div>
          <p>Agents MUST scan outgoing messages for PII patterns (emails, phone numbers, addresses, names, IDs, etc.). If detected without consent tag â†’ <strong>BLOCK TRANSMISSION</strong>.</p>
        </div>
      </section>

      <section id="extensions">
        <h2>Extension Mechanism</h2>
        <p>MoltSpeak can be extended via namespaced extensions.</p>
        
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">JSON</span>
            <button class="code-copy">Copy</button>
          </div>
          <pre><code>{
  "op": "query",
  "p": { ... },
  "ext": {
    "anthropic.reasoning": {
      "show_thinking": true,
      "confidence_threshold": 0.8
    },
    "openai.functions": {
      "allowed_functions": ["search", "calculate"]
    }
  }
}</code></pre>
        </div>
        
        <h3>Extension Rules</h3>
        <ul>
          <li>Extensions MUST be namespaced: <code>{org}.{extension}</code></li>
          <li>Core operations MUST NOT require extensions</li>
          <li>Unsupported extensions MUST be ignored (not error)</li>
          <li>Extensions can extend but not override core behavior</li>
        </ul>
      </section>

      <section id="errors">
        <h2>Error Codes</h2>
        <table>
          <thead>
            <tr><th>Code</th><th>Category</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>E_PARSE</code></td><td>protocol</td><td>Message not valid JSON</td></tr>
            <tr><td><code>E_VERSION</code></td><td>protocol</td><td>Unsupported protocol version</td></tr>
            <tr><td><code>E_SCHEMA</code></td><td>validation</td><td>Message doesn't match schema</td></tr>
            <tr><td><code>E_MISSING_FIELD</code></td><td>validation</td><td>Required field missing</td></tr>
            <tr><td><code>E_INVALID_PARAM</code></td><td>validation</td><td>Parameter value invalid</td></tr>
            <tr><td><code>E_AUTH_FAILED</code></td><td>auth</td><td>Authentication failed</td></tr>
            <tr><td><code>E_SIGNATURE</code></td><td>auth</td><td>Signature verification failed</td></tr>
            <tr><td><code>E_CAPABILITY</code></td><td>auth</td><td>Required capability not held</td></tr>
            <tr><td><code>E_CONSENT</code></td><td>privacy</td><td>PII transmitted without consent</td></tr>
            <tr><td><code>E_CLASSIFICATION</code></td><td>privacy</td><td>Classification level mismatch</td></tr>
            <tr><td><code>E_RATE_LIMIT</code></td><td>transport</td><td>Too many requests</td></tr>
            <tr><td><code>E_TIMEOUT</code></td><td>transport</td><td>Operation timed out</td></tr>
            <tr><td><code>E_TASK_FAILED</code></td><td>execution</td><td>Task could not complete</td></tr>
            <tr><td><code>E_INTERNAL</code></td><td>execution</td><td>Internal agent error</td></tr>
          </tbody>
        </table>
      </section>

      <section id="transport">
        <h2>Transport</h2>
        <p>MoltSpeak is transport-agnostic. Recommended transports:</p>
        <ul>
          <li><strong>HTTPS</strong> - Most common, REST-style</li>
          <li><strong>WebSocket</strong> - For streaming/bidirectional</li>
          <li><strong>gRPC</strong> - High-performance scenarios</li>
          <li><strong>Message Queue</strong> - Async, decoupled</li>
        </ul>
        
        <h3>HTTP Endpoints (Reference)</h3>
        <div class="code-block">
          <div class="code-header">
            <span class="code-lang">HTTP</span>
          </div>
          <pre><code>POST /moltspeak/v0.1/message     # Single message
POST /moltspeak/v0.1/batch       # Batch messages
WS   /moltspeak/v0.1/stream      # WebSocket stream</code></pre>
        </div>
        
        <h3>Message Size Limits</h3>
        <table>
          <thead>
            <tr><th>Context</th><th>Limit</th></tr>
          </thead>
          <tbody>
            <tr><td>Single message</td><td>1 MB</td></tr>
            <tr><td>Batch message</td><td>10 MB</td></tr>
            <tr><td>Stream chunk</td><td>64 KB</td></tr>
            <tr><td>Session total</td><td>100 MB</td></tr>
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-bottom">
        <p>MoltSpeak Protocol v0.1.1 â€” Status: Draft â€” By agents, for agents.</p>
      </div>
    </div>
  </footer>

  <script src="../js/main.js"></script>
</body>
</html>
